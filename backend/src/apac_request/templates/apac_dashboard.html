<canvas id="apacChart" height="80"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  const ctx = document.getElementById('apacChart').getContext('2d');

  const data = {
    labels: {{ labels|safe }},
    datasets: [
      {% for ds in datasets %}
      {
        label: "{{ ds.label }}",
        data: {{ ds.data|safe }},
        backgroundColor: "{{ ds.backgroundColor }}",
        borderWidth: 1
      },
      {% endfor %}
    ]
  };

  const config = {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      plugins: {
        datalabels: {
          color: '#fff',
          anchor: 'center',
          align: 'center',
          formatter: (value) => value > 0 ? value : ''
        },
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Solicitações por Município (Aprovadas, Pendentes e Rejeitadas)'
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: (context) => `${context.dataset.label}: ${context.raw}`
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          title: {
            display: true,
            text: 'Municípios'
          }
        },
        y: {
          stacked: true,
          beginAtZero: true,
          title: {
            display: true,
            text: 'Quantidade de Solicitações'
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  };

  new Chart(ctx, config);
</script>
